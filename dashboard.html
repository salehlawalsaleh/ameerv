<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9jame Dashboard</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
      color: #333;
      text-align: center;
    }
    header {
      background: #0f172a;
      color: white;
      padding: 1rem 0;
      font-size: 1.2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .container {
      max-width: 400px;
      margin: 2rem auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      padding: 20px;
    }
    .balance-box {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .balance-amount {
      font-size: 1.8rem;
      color: #0ea5e9;
    }
    button {
      background: #0ea5e9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }
    button:hover {
      background: #0284c7;
    }
    .green-btn {
      background: #10b981;
    }
    .green-btn:hover {
      background: #059669;
    }
    .gray-btn {
      background: #64748b;
    }
    .gray-btn:hover {
      background: #475569;
    }
    #fundModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      width: 90%;
      max-width: 320px;
    }
    .modal-content input {
      width: 80%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 1rem;
    }
    footer {
      margin-top: 30px;
      color: #64748b;
      font-size: 0.9rem;
    }
    a {
      color: #0ea5e9;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .history {
      background: #f8fafc;
      border-radius: 10px;
      padding: 10px;
      margin-top: 12px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.9rem;
      display: none; /* hidden by default (collapsed) */
      transition: max-height 0.25s ease;
    }
    .history-item {
      padding: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-toggle {
      display: inline-block;
      margin-bottom: 8px;
      background: transparent;
      color: #0ea5e9;
      border: 1px solid #0ea5e9;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Status styling per request (minimal additions) */
    .status-success {
      color: #10b981; /* green - keep as is */
      font-weight: 600;
    }
    .status-pending {
      color: #b45309; /* dark yellow / amber-700 */
      font-weight: 700;
    }
    .status-debit {
      color: #ef4444; /* red for debit */
      font-weight: 600;
    }

    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Modern verify notification (custom toast) */
    .verify-toast-wrap {
      position: fixed;
      right: 20px;
      bottom: 28px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
      pointer-events: none;
    }
    .verify-toast {
      min-width: 260px;
      max-width: 360px;
      background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(250,250,250,0.95));
      box-shadow: 0 8px 30px rgba(2,8,23,0.12);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      gap: 12px;
      align-items: center;
      pointer-events: auto;
      transform: translateY(8px);
      opacity: 0;
      transition: transform .28s cubic-bezier(.2,.9,.2,1), opacity .28s;
      border-left: 6px solid transparent;
    }
    .verify-toast.show { transform: translateY(0); opacity: 1; }
    .verify-toast.success { border-left-color: #10b981; }
    .verify-toast.error { border-left-color: #ef4444; }
    .verify-toast .icon {
      width: 44px; height: 44px; border-radius: 10px; display:grid; place-items:center;
      background: rgba(15,23,42,0.04); font-weight:800;
    }
    .verify-toast .content {
      text-align: left; flex:1;
    }
    .verify-toast .title { font-weight:800; font-size:14px; color:#0f172a; margin-bottom:2px; }
    .verify-toast .desc { font-size:13px; color:#475569; line-height:1.15; }
    .verify-toast .actions { margin-left:8px; display:flex; gap:8px; align-items:center; }
    .verify-toast .btn { padding:6px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .verify-toast .btn.primary { background:#0ea5e9; color:white; }
    .verify-toast .btn.ghost { background:transparent; color:#0f172a; border:1px solid rgba(15,23,42,0.06); }

    /* small helper for time text */
    .tx-meta { display:block; color:#6b7280; font-size:12px; margin-top:6px; }
    .tx-extra { display:block; color:#374151; font-size:12px; margin-top:4px; }
  </style>
</head>
<body>

  <header>9jame Dashboard</header>

  <div class="container">
    <h2 id="welcomeText">Welcome, Guest</h2>
    <p id="userIdText">User ID: -</p>

    <div class="balance-box">
      <p>Available Balance:</p>
      <p class="balance-amount">₦<span id="balance">0</span></p>
    </div>

    <button id="addFundBtn">Add Fund</button>
    <button id="verifyBtn" class="green-btn">Verify Payment</button>

    <hr style="margin:20px 0;">

    <h3 style="margin-bottom:6px;">Transaction History</h3>
    <button id="historyToggleBtn" class="history-toggle" aria-expanded="false">View History</button>
    <div id="history" class="history" aria-hidden="true">Loading...</div>

    <hr style="margin:20px 0;">

    <p>Get your NIN Plastic now — even if you never got it before. Don’t worry!</p>
    <button id="getNINBtn" class="gray-btn">Get NIN Plastic Now</button>

    <p style="margin-top:20px; font-weight:bold;">Verify Me ✅</p>
  </div>

  <!-- Add Fund Modal -->
  <div id="fundModal">
    <div class="modal-content">
      <h3>Add Fund</h3>
      <input type="number" id="fundAmount" placeholder="Enter amount (₦)" />
      <div>
        <button id="payNowBtn">Pay Now</button>
        <button id="cancelBtn" class="gray-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Verify toast wrapper -->
  <div class="verify-toast-wrap" id="verifyToastWrap" aria-live="polite" aria-atomic="true"></div>

  <footer>
    <p>Need help? <a href="https://wa.me/2348145415083" target="_blank" rel="noopener">Contact Support</a></p>
    <p>Design by <strong>Atech ICT Solution</strong></p>
  </footer>

<script>
const baseURL = "https://9jame.netlify.app/.netlify/functions";
const FIREBASE_DB_URL = "https://ameernin-ba310-default-rtdb.firebaseio.com";

// --- Auth check: require login (no access to dashboard if not logged in) ---
let userId = null;
let username = null;

try {
  const stored = localStorage.getItem('user');
  if (stored) {
    const obj = JSON.parse(stored);
    if (obj && obj.userId) {
      userId = obj.userId;
      username = obj.username || obj.email || "User";
    }
  }
} catch (e) {
  // ignore parse errors
}

if (!userId) {
  const uid = localStorage.getItem('userId');
  const uname = localStorage.getItem('username');
  if (uid) userId = uid;
  if (uname) username = uname;
}

if (!userId) {
  alert("Please log in to access the dashboard.");
  window.location.href = "index.html";
} else {
  document.getElementById("welcomeText").innerText = `Welcome, ${username || 'User'}`;
  document.getElementById("userIdText").innerText = `User ID: ${userId}`;
}

/* ========== Custom verify notification ========== */
function showVerifyNotification({ title='Notification', desc='', type='success', timeout=4500, actions=[] } = {}) {
  const wrap = document.getElementById('verifyToastWrap');
  const el = document.createElement('div');
  el.className = `verify-toast ${type}`;
  el.innerHTML = `
    <div class="icon">${ type === 'success' ? '✓' : '!' }</div>
    <div class="content">
      <div class="title">${title}</div>
      <div class="desc">${desc}</div>
    </div>
    <div class="actions">
      ${actions.map(a=>`<button class="btn ${a.primary ? 'primary' : 'ghost'}" data-act="${a.action || ''}">${a.label}</button>`).join('')}
    </div>
  `;
  wrap.appendChild(el);
  // attach action handlers
  el.querySelectorAll('.btn').forEach(b=>{
    b.addEventListener('click', (e)=>{
      const act = b.getAttribute('data-act');
      try { if(act === 'view-history') { document.getElementById('historyToggleBtn').click(); } 
            else if(act === 'close') { /* nothing */ } 
            else if(typeof window[act] === 'function') window[act]();
      } catch(e){ console.error(e); }
      // remove toast immediately
      el.classList.remove('show');
      setTimeout(()=>el.remove(), 280);
    });
  });
  // show
  requestAnimationFrame(()=> el.classList.add('show'));
  // auto remove
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, timeout);
}

/* ========== Balance & History functions ========== */
async function updateBalance() {
  if (!userId) return;
  try {
    const res = await fetch(`${FIREBASE_DB_URL}/users/${encodeURIComponent(userId)}.json`);
    const data = await res.json();
    document.getElementById("balance").innerText = data?.balance || 0;
  } catch {
    document.getElementById("balance").innerText = "0";
  }
}

// load history but keep it hidden until user opens it
async function loadHistory() {
  const historyDiv = document.getElementById("history");
  if (!userId) {
    historyDiv.innerHTML = "No user.";
    return;
  }
  historyDiv.innerHTML = "Loading...";
  try {
    // fetch both possible locations:
    // 1) old structure: /transactions/{userId}
    // 2) ni.html structure: /users/{userId}/transactions
    const [res1, res2] = await Promise.all([
      fetch(`${FIREBASE_DB_URL}/transactions/${encodeURIComponent(userId)}.json`),
      fetch(`${FIREBASE_DB_URL}/users/${encodeURIComponent(userId)}/transactions.json`)
    ]);
    const data1 = await res1.json().catch(()=>null);
    const data2 = await res2.json().catch(()=>null);

    const txs1 = data1 ? Object.values(data1) : [];
    const txs2 = data2 ? Object.values(data2) : [];

    // merge and sort reverse-chronological by timestamp/createdAt fields if available
    const merged = [...txs1, ...txs2].map(tx => {
      // normalize timestamp for sorting
      const ts = tx.timestamp || tx.createdAt || tx.verifiedAt || tx.date || Date.now();
      return { ...tx, _ts: new Date(ts).getTime() || Date.now() };
    }).sort((a,b)=> b._ts - a._ts);

    // Filter: only show DEBIT transactions (include generate action from ni.html)
    const debitTxs = merged.filter(tx => {
      try {
        const type = (tx.type || tx.direction || tx.action || '').toString().toLowerCase();
        const isDebitFlag = tx.isDebit === true || tx.is_debit === true;
        const amountNegative = tx.amount !== undefined && !isNaN(Number(tx.amount)) && Number(tx.amount) < 0;
        return type === 'debit' || isDebitFlag || amountNegative || type === 'generate';
      } catch (e) {
        return false;
      }
    });

    if (!debitTxs || debitTxs.length === 0) {
      historyDiv.innerHTML = "No debit transactions.";
      return;
    }

    historyDiv.innerHTML = debitTxs.map(tx => {
      const statusRaw = (tx.status || tx.state || '').toString().toLowerCase();
      let statusLabel = (tx.status || '').toString().toUpperCase() || 'UNKNOWN';
      let statusClass = '';

      if (statusRaw === 'success' || statusRaw === 'verified') {
        statusClass = 'status-success';
        statusLabel = 'SUCCESS';
      } else if (statusRaw === 'pending') {
        statusClass = 'status-pending';
        statusLabel = 'PENDING';
      } else {
        // if it's a debit/generate but not success/pending => mark as debit (red)
        statusClass = 'status-debit';
        statusLabel = (tx.action ? (tx.action.toString().toUpperCase()) : (tx.status || 'DEBIT').toString().toUpperCase());
      }

      const when = new Date(tx.createdAt || tx.timestamp || tx.verifiedAt || Date.now()).toLocaleString();
      const amountDisplay = (tx.amount !== undefined && tx.amount !== null) ? tx.amount : (tx.value || '');

      // include NIN info if present (from ni.html records)
      const ninInfo = tx.nin ? `<div class="tx-extra">NIN: ${String(tx.nin)}</div>` : '';
      const actionInfo = tx.action ? `<div class="tx-extra">Action: ${tx.action}</div>` : '';

      return `
        <div class="history-item">
          <strong>₦${amountDisplay}</strong> - <span class="${statusClass}">${statusLabel}</span><br>
          <small class="tx-meta">${when}</small>
          ${ninInfo}
          ${actionInfo}
        </div>
      `;
    }).join('');
  } catch (err) {
    console.error(err);
    historyDiv.innerHTML = "Failed to load history.";
  }
}

// initial balance load
updateBalance();

/* ========== VERIFY function used by manual button and auto-on-enter/focus ========== */
async function runVerify(reference) {
  if (!userId || !reference) return { ok: false, message: "No reference or user." };

  const verifyBtn = document.getElementById('verifyBtn');
  const prevText = verifyBtn.innerText;
  verifyBtn.disabled = true;
  verifyBtn.innerText = 'Verifying...';

  try {
    const res = await fetch(`${baseURL}/verify-transaction`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reference, userId })
    });
    const data = await res.json();

    verifyBtn.disabled = false;
    verifyBtn.innerText = prevText;

    if (data.status === "ok") {
      // success
      localStorage.removeItem("ref");
      updateBalance();
      if (document.getElementById('history').style.display === 'block') loadHistory();

      // show modern verify notification (custom)
      showVerifyNotification({
        title: 'Payment verified',
        desc: 'Your payment was verified and your balance updated.',
        type: 'success',
        timeout: 5000,
        actions: [{ label: 'View history', action: 'view-history', primary: true }]
      });

      return { ok: true, data };
    } else {
      // not successful yet
      // show friendly non-blocking notification for pending
      showVerifyNotification({
        title: 'Verification pending',
        desc: (data.error || 'Payment not verified yet. Try again after a while.'),
        type: 'error',
        timeout: 4500,
        actions: [{ label: 'OK', action: 'close' }]
      });
      return { ok: false, data };
    }
  } catch (err) {
    console.error('verify error', err);
    verifyBtn.disabled = false;
    verifyBtn.innerText = prevText;

    showVerifyNotification({
      title: 'Verification failed',
      desc: 'Could not reach verification service. Check connection or try later.',
      type: 'error',
      timeout: 5000,
      actions: [{ label: 'OK', action: 'close' }]
    });

    return { ok: false, error: err };
  }
}

/* ========== Auto-verify ONCE when entering dashboard or returning to it (focus). ========== */
async function tryAutoVerifyOnce() {
  if (!userId) return;
  const ref = localStorage.getItem('ref');
  if (!ref) return;
  try {
    const result = await runVerify(ref);
    if (result.ok) {
      // notification already shown in runVerify
      console.log('Auto-verify success');
    } else {
      console.log('Auto-verify attempted; not yet verified.', result);
    }
  } catch (e) {
    console.error('Auto-verify failure', e);
  }
}

// Try auto-verify when page loads (but after we set user info)
tryAutoVerifyOnce();

// Also try auto-verify when window regains focus (i.e., user returns to dashboard)
window.addEventListener('focus', () => {
  updateBalance();
  if (document.getElementById('history').style.display === 'block') loadHistory();
  tryAutoVerifyOnce();
});

/* ========== History toggle logic (collapsed drawer) ========== */
const historyToggleBtn = document.getElementById('historyToggleBtn');
historyToggleBtn.addEventListener('click', async () => {
  const historyDiv = document.getElementById('history');
  const isOpen = historyDiv.style.display === 'block';
  if (isOpen) {
    historyDiv.style.display = 'none';
    historyDiv.setAttribute('aria-hidden', 'true');
    historyToggleBtn.setAttribute('aria-expanded', 'false');
    historyToggleBtn.innerText = 'View History';
  } else {
    // open and load history
    historyDiv.style.display = 'block';
    historyDiv.setAttribute('aria-hidden', 'false');
    historyToggleBtn.setAttribute('aria-expanded', 'true');
    historyToggleBtn.innerText = 'Hide History';
    await loadHistory();
  }
});

/* ========== Modal logic (unchanged) ========== */
const fundModal = document.getElementById("fundModal");
document.getElementById("addFundBtn").onclick = () => fundModal.style.display = "flex";
document.getElementById("cancelBtn").onclick = () => fundModal.style.display = "none";

document.getElementById("payNowBtn").onclick = async () => {
  if (!userId) return alert("Please log in to add funds.");
  const amount = parseInt(document.getElementById("fundAmount").value);
  if (!amount || amount < 50) return alert("Please enter at least ₦50");
  fundModal.style.display = "none";
  const res = await fetch(`${baseURL}/create-transaction`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, amount })
  });
  const data = await res.json();
  if (data.checkoutUrl) {
    localStorage.setItem("ref", data.reference);
    window.open(data.checkoutUrl, "_blank");
    alert("Payment page opened. After payment, you can return to dashboard and verification will run automatically once, or you may click Verify.");
  } else {
    alert("Error: " + (data.error || JSON.stringify(data)));
  }
};

/* ========== Manual Verify Payment (uses runVerify which now shows modern notification) ========== */
document.getElementById("verifyBtn").onclick = async () => {
  if (!userId) return alert("Please log in to verify payments.");
  const ref = localStorage.getItem("ref");
  if (!ref) return alert("No pending transaction to verify.");
  const result = await runVerify(ref);
  if (result.ok) {
    // runVerify already showed modern success notification
    localStorage.removeItem("ref");
    updateBalance();
    if (document.getElementById('history').style.display === 'block') loadHistory();
  } else {
    // runVerify already showed notification explaining pending or error
  }
};

// Get NIN button
document.getElementById("getNINBtn").onclick = () => {
  window.location.href = "ni.html";
};
</script>
</body>
</html>
