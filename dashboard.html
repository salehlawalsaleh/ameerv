<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VerifyMe Dashboard</title>
  <!-- Font Awesome (kept, optional) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-p1Cm6Y9K6Qe5j7G2y6r6Zg0Qkz1q3b9gkM3Y1P1YJ0gqQ+5x1JZ0+JxjF5rK7qV0J9yLz2bY0pE6v7q1l9Qxw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
      color: #333;
      text-align: center;
    }
    header {
      background: #0f172a;
      color: white;
      padding: 1rem 0;
      font-size: 1.2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .container {
      max-width: 400px;
      margin: 2rem auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      padding: 20px;
    }
    .balance-box {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .balance-amount {
      font-size: 1.8rem;
      color: #0ea5e9;
    }
    button {
      background: #0ea5e9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }
    button:hover { background: #0284c7; }
    .green-btn { background: #10b981; }
    .green-btn:hover { background: #059669; }
    .gray-btn { background: #64748b; }
    .gray-btn:hover { background: #475569; }
    #fundModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      width: 90%;
      max-width: 320px;
    }
    .modal-content input {
      width: 80%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 1rem;
    }
    footer {
      margin-top: 30px;
      color: #64748b;
      font-size: 0.9rem;
    }
    a { color: #0ea5e9; text-decoration: none; }
    a:hover { text-decoration: underline; }/* History styling - preserve margins of items */
.history {
  background: #f8fafc;
  border-radius: 10px;
  padding: 10px;
  margin-top: 12px;
  text-align: left;
  max-height: 200px;
  overflow-y: auto;
  font-size: 0.9rem;
  display: none;
}
.history-item {
  padding: 6px;
  border-bottom: 1px solid #e5e7eb;
}
.history-item:last-child { border-bottom: none; }
.history-toggle {
  display: inline-block;
  margin-bottom: 8px;
  background: transparent;
  color: #0ea5e9;
  border: 1px solid #0ea5e9;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
}

/* Status colors */
.status-success { color: #10b981; font-weight: 600; }
.status-pending { color: #ef4444; font-weight: 700; }

button[disabled] { opacity: 0.6; cursor: not-allowed; }

/* === Toast styles (minimal modern) === */
#toast-container {
position: fixed;
right: 20px;
bottom: 20px;
z-index: 2000;
display: flex;
flex-direction: column;
gap: 10px;
align-items: flex-end;
pointer-events: none;
}
.toast {
min-width: 220px;
max-width: 360px;
background: #ffffff;
color: #0f172a;
padding: 12px 14px;
border-radius: 10px;
box-shadow: 0 6px 18px rgba(2,6,23,0.12);
display: flex;
gap: 12px;
align-items: center;
font-size: 0.95rem;
pointer-events: auto;
border-left: 4px solid transparent;
transform-origin: 100% 100%;
animation: toast-in 260ms ease-out;
}
.toast .icon { width: 36px; height: 36px; border-radius: 8px; display: grid; place-items: center; font-weight: 700; font-size: 18px; }
.toast.info { border-left-color: #0ea5e9; }
.toast.success { border-left-color: #10b981; }
.toast.error { border-left-color: #ef4444; }
.toast.info .icon { background: rgba(14,165,233,0.08); color: #0369a1; }
.toast.success .icon { background: rgba(16,185,129,0.08); color: #065f46; }
.toast.error .icon { background: rgba(239,68,68,0.08); color: #7f1d1d; }
.toast .content { flex: 1; text-align: left; }
.toast .close-btn { background: transparent; border: none; cursor: pointer; font-size: 14px; opacity: 0.7; padding: 4px; }
.toast .close-btn:hover { opacity: 1; }

@keyframes toast-in { from { transform: translateY(10px) scale(.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
@keyframes toast-out { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(10px) scale(.98); opacity: 0; } }

/* Logout confirmation modal (keeps style consistent with fund modal) */
#logoutModal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.logout-actions { display:flex; gap:10px; justify-content:center; margin-top:12px; }
  </style>
</head>
<body>
  <header>
    <!-- Heading changed to VerifyMe as requested -->
    VerifyMe
    <!-- Sign out button (text) -->
    <button id="logoutBtn" class="green-btn" aria-label="Sign out" style="margin-left:30px; padding:8px 10px;">
      Sign out
    </button>
  </header>

  <div class="container">
    <h2 id="welcomeText">Welcome, Guest</h2>
    <p id="userIdText">User ID: -</p>

    <div class="balance-box">
      <p>Available Balance:</p>
      <p class="balance-amount">₦<span id="balance">0</span></p>
    </div>

    <button id="addFundBtn">Add Fund</button>
    <button id="verifyBtn" class="green-btn">Verify Payment</button>

    <hr style="margin:20px 0;">

    <h3 style="margin-bottom:6px;">Transaction History</h3>
    <button id="historyToggleBtn" class="history-toggle" aria-expanded="false">View History</button>
    <div id="history" class="history" aria-hidden="true">Loading...</div>

    <hr style="margin:20px 0;">

    <p>Get your NIN Plastic now — even if you never got it before. Don’t worry!</p>
    <button id="getNINBtn" class="gray-btn">Get NIN Plastic Now</button>

    <!-- Verify Me with Font Awesome verified icon -->
    <p id="verifyMe" style="margin-top:20px; font-weight:bold;">
      <i class="fa-solid fa-badge-check" aria-hidden="true" style="margin-right:8px;"></i> Verify Me
    </p>
  </div>

  <!-- Add Fund Modal -->
  <div id="fundModal">
    <div class="modal-content">
      <h3>Add Fund</h3>
      <input type="number" id="fundAmount" placeholder="Enter amount (₦)" />
      <div>
        <button id="payNowBtn">Pay Now</button>
        <button id="cancelBtn" class="gray-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Logout confirmation modal -->
  <div id="logoutModal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
    <div class="modal-content" style="max-width:340px;">
      <h3 id="logoutTitle">Confirm sign out</h3>
      <p>Are you ready to Signout, but you can login back</p>
      <div class="logout-actions">
        <button id="confirmSignoutYes" class="green-btn">Yes</button>
        <button id="confirmSignoutNo" class="gray-btn">No</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Need help? <a href="https://wa.me/2348145415083" target="_blank" rel="noopener">Contact Support</a></p>
    <p>Design by <strong>Atech ICT Solution</strong></p>
  </footer>

  <!-- Toast container -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    /* ======= Configuration ======= */
    const baseURL = "https://verifymynin.netlify.app/.netlify/functions";

    // Firebase config (same as your auth page)
    const firebaseConfig = {
      apiKey: "AIzaSyDc0bIipHU7N73mju33dNwSWmH3IeIYkog",
      authDomain: "ameernin-ba310.firebaseapp.com",
      databaseURL: "https://ameernin-ba310-default-rtdb.firebaseio.com",
      projectId: "ameernin-ba310",
      storageBucket: "ameernin-ba310.appspot.com",
      messagingSenderId: "522206845073",
      appId: "1:522206845073:web:3c85714bd7eda6c1048730",
    };

    /* ======= Toast utility ======= */
    function showToast(message, type = "info", duration = 3500) {
      try {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = document.createElement('div');
        icon.className = 'icon';
        icon.innerText = type === 'success' ? '✓' : (type === 'error' ? '!' : 'i');

        const content = document.createElement('div');
        content.className = 'content';
        content.innerText = message;

        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.setAttribute('aria-label', 'Close notification');
        closeBtn.innerText = '×';
        closeBtn.onclick = () => removeToast(toast);

        toast.appendChild(icon);
        toast.appendChild(content);
        toast.appendChild(closeBtn);

        container.appendChild(toast);

        const timeoutId = setTimeout(() => { removeToast(toast); }, duration);

        toast.addEventListener('click', (e) => { if (e.target !== closeBtn) removeToast(toast); clearTimeout(timeoutId); });

        function removeToast(el) {
          el.style.animation = 'toast-out 200ms ease-in';
          el.style.opacity = '0';
          setTimeout(() => { if (el && el.parentNode) el.parentNode.removeChild(el); }, 220);
        }
      } catch (err) { console.error('toast error', err); }
    }

    /* ======= Firebase imports & init ======= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getDatabase,
      ref as dbRef,
      get,
      set as dbSet
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    /* ======= DOM elements ======= */
    const welcomeText = document.getElementById("welcomeText");
    const userIdText = document.getElementById("userIdText");
    const balanceEl = document.getElementById("balance");
    const historyDiv = document.getElementById("history");
    const fundModal = document.getElementById("fundModal");
    const addFundBtn = document.getElementById("addFundBtn");
    const payNowBtn = document.getElementById("payNowBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const verifyBtn = document.getElementById("verifyBtn");
    const historyToggleBtn = document.getElementById("historyToggleBtn");
    const getNINBtn = document.getElementById("getNINBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const logoutModal = document.getElementById("logoutModal");
    const confirmYes = document.getElementById("confirmSignoutYes");
    const confirmNo = document.getElementById("confirmSignoutNo");

    /* ======= State ======= */
    let currentUid = null;
    let currentUsername = null;

    /* ======= Helpers ======= */
    async function fetchUserRecord(uid) {
      try {
        const snap = await get(dbRef(db, `users/${uid}`));
        return snap.exists() ? snap.val() : null;
      } catch (err) {
        console.error('fetchUserRecord error', err);
        return null;
      }
    }

    async function writeUserRecordIfMissing(uid, record) {
      try {
        await dbSet(dbRef(db, `users/${uid}`), record);
        return true;
      } catch (err) {
        console.error('writeUserRecordIfMissing error', err);
        return false;
      }
    }

    /* ======= Auth observer (use ONLY Firebase Auth UID) ======= */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not logged in → redirect to login
        currentUid = null;
        currentUsername = null;
        showToast("Not logged in. Redirecting to login...", "info", 1200);
        setTimeout(() => { window.location.href = "index.html"; }, 900);
        return;
      }

      // Signed in — use auth uid only (no localStorage userId)
      currentUid = user.uid;
      currentUsername = user.displayName || (user.email ? user.email.split('@')[0] : 'User');

      // Update UI
      welcomeText.innerText = `Welcome, ${currentUsername}`;
      userIdText.innerText = `User ID: ${currentUid}`;

      // ensure DB record exists for this uid
      const dbUser = await fetchUserRecord(currentUid);
      if (!dbUser) {
        await writeUserRecordIfMissing(currentUid, {
          name: currentUsername,
          email: user.email || '',
          balance: 0,
          demoCount: 0,
          createdAt: Date.now()
        });
        balanceEl.innerText = 0;
      } else {
        // optionally sync name from auth -> DB
        if (user.displayName && dbUser.name !== user.displayName) {
          try {
            await dbSet(dbRef(db, `users/${currentUid}/name`), user.displayName);
          } catch (e) { console.warn('Could not sync DB name from auth', e); }
        }
        balanceEl.innerText = (dbUser.balance ?? 0);
      }

      // If history visible, load it
      if (historyDiv.style.display === 'block') loadHistory();

      // attempt auto-verify pending ref if any
      tryAutoVerifyOnce();
    });

    /* ======= Balance & History ======= */
    async function updateBalance() {
      if (!currentUid) return;
      const dbUser = await fetchUserRecord(currentUid);
      balanceEl.innerText = (dbUser?.balance ?? 0);
    }

    async function loadHistory() {
      historyDiv.innerHTML = "Loading...";
      if (!currentUid) { historyDiv.innerHTML = "No user."; return; }
      try {
        const snap = await get(dbRef(db, `transactions/${currentUid}`));
        if (!snap.exists()) { historyDiv.innerHTML = "No transactions yet."; return; }
        const data = snap.val();
        const txs = Object.values(data).reverse();
        historyDiv.innerHTML = txs.map(tx => {
          const statusRaw = (tx.status || tx.state || '').toString().toLowerCase();
          let statusLabel = (tx.status || '').toString().toUpperCase() || 'UNKNOWN';
          let statusClass = '';
          if (statusRaw === 'success' || statusRaw === 'verified') { statusClass = 'status-success'; statusLabel = 'SUCCESS'; }
          else if (statusRaw === 'pending') { statusClass = 'status-pending'; statusLabel = 'PENDING'; }
          const when = new Date(tx.createdAt || tx.verifiedAt || Date.now()).toLocaleString();
          const amountDisplay = (tx.amount !== undefined) ? tx.amount : (tx.value || '');
          return `
            <div class="history-item">
              <strong>₦${amountDisplay}</strong> - <span class="${statusClass}">${statusLabel}</span><br>
              <small>${when}</small>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('loadHistory error', err);
        historyDiv.innerHTML = "Failed to load history.";
      }
    }

    /* ======= Verify ======= */
    async function runVerify(reference) {
      if (!currentUid || !reference) return { ok: false, message: "No reference or user." };
      const prevText = verifyBtn.innerText;
      verifyBtn.disabled = true;
      verifyBtn.innerText = 'Verifying...';
      try {
        const res = await fetch(`${baseURL}/verify-transaction`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reference, userId: currentUid })
        });
        const data = await res.json();
        verifyBtn.disabled = false;
        verifyBtn.innerText = prevText;
        if (data.status === "ok") {
          localStorage.removeItem("ref");
          await updateBalance();
          if (historyDiv.style.display === 'block') await loadHistory();
          // update verifyMe UI to show verified icon (optional)
          const verifyMeEl = document.getElementById('verifyMe');
          if (verifyMeEl) verifyMeEl.innerHTML = '<i class="fa-solid fa-circle-check" aria-hidden="true" style="margin-right:8px;"></i> Verified';
          return { ok: true, data };
        } else return { ok: false, data };
      } catch (err) {
        console.error('verify error', err);
        verifyBtn.disabled = false;
        verifyBtn.innerText = prevText;
        return { ok: false, error: err };
      }
    }

    async function tryAutoVerifyOnce() {
      if (!currentUid) return;
      const ref = localStorage.getItem('ref');
      if (!ref) return;
      try {
        const result = await runVerify(ref);
        if (result.ok) { showToast("Payment verified automatically — balance updated.", "success"); }
        else console.log('Auto-verify attempted; not yet verified.', result);
      } catch (e) { console.error('Auto-verify failure', e); }
    }

    /* ======= Window focus updates ======= */
    window.addEventListener('focus', () => {
      updateBalance();
      if (historyDiv.style.display === 'block') loadHistory();
      tryAutoVerifyOnce();
    });

    /* ======= History toggle ======= */
    historyToggleBtn.addEventListener('click', async () => {
      const isOpen = historyDiv.style.display === 'block';
      if (isOpen) {
        historyDiv.style.display = 'none';
        historyDiv.setAttribute('aria-hidden', 'true');
        historyToggleBtn.setAttribute('aria-expanded', 'false');
        historyToggleBtn.innerText = 'View History';
      } else {
        historyDiv.style.display = 'block';
        historyDiv.setAttribute('aria-hidden', 'false');
        historyToggleBtn.setAttribute('aria-expanded', 'true');
        historyToggleBtn.innerText = 'Hide History';
        await loadHistory();
      }
    });

    /* ======= Modal handlers ======= */
    addFundBtn.onclick = () => { if (!currentUid) { showToast("Please log in to add funds.", "error"); return; } fundModal.style.display = "flex"; };
    cancelBtn.onclick = () => fundModal.style.display = "none";

    /* ======= Create transaction (Add Fund) ======= */
    payNowBtn.onclick = async () => {
      if (!currentUid) { showToast("Please log in to add funds.", "error"); return; }
      const amount = parseInt(document.getElementById("fundAmount").value, 10);
      if (!amount || amount < 50) { showToast("Please enter at least ₦50", "error"); return; }
      fundModal.style.display = "none";

      const payload = { userId: currentUid, amount };
      console.log("create-transaction request:", payload);

      try {
        const res = await fetch(`${baseURL}/create-transaction`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        console.log("create-transaction status:", res.status, res.statusText);

        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (e) { data = null; }

        if (!res.ok) {
          console.error("create-transaction non-OK:", res.status, text);
          showToast("Server error creating transaction. Check console.", "error");
          return;
        }

        if (!data) {
          console.error("create-transaction returned non-JSON:", text);
          showToast("Server returned unexpected response. Check console.", "error");
          return;
        }

        if (data.checkoutUrl) {
          localStorage.setItem("ref", data.reference || "");
          const newWin = window.open(data.checkoutUrl, "_blank");
          if (!newWin || newWin.closed || typeof newWin.closed === 'undefined') {
            window.location.href = data.checkoutUrl;
          }
          showToast("Payment page opened. After payment, return to dashboard and verify.", "info");
        } else {
          console.error("create-transaction payload error:", data);
          showToast("Error creating payment: " + (data.error || "See console"), "error");
        }
      } catch (err) {
        console.error('create-transaction fetch error', err);
        showToast("Network error creating transaction. Check console.", "error");
      }
    };

    /* ======= Manual verify ======= */
    verifyBtn.onclick = async () => {
      if (!currentUid) { showToast("Please log in to verify payments.", "error"); return; }
      const ref = localStorage.getItem("ref");
      if (!ref) { showToast("No pending transaction to verify.", "info"); return; }
      const result = await runVerify(ref);
      if (result.ok) {
        showToast("Payment verified successfully! Balance updated.", "success");
        localStorage.removeItem("ref");
        await updateBalance();
        if (historyDiv.style.display === 'block') await loadHistory();
      } else showToast("Verification attempt: " + (result.data?.error || "Not yet verified. Return to dashboard after completing payment or try again."), "info");
    };

    /* ======= Get NIN button ======= */
    getNINBtn.onclick = () => { window.location.href = "ni.html"; };

    /* ======= Logout handler with confirmation ======= */
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // show confirmation modal
        if (logoutModal) logoutModal.style.display = 'flex';
      });
    }

    if (confirmNo) {
      confirmNo.addEventListener('click', () => {
        if (logoutModal) logoutModal.style.display = 'none';
      });
    }

    if (confirmYes) {
      confirmYes.addEventListener('click', async () => {
        if (logoutModal) logoutModal.style.display = 'none';
        try {
          await signOut(auth);
          showToast("Logged out.", "info", 1000);
          setTimeout(() => { window.location.href = 'index.html'; }, 700);
        } catch (e) {
          console.error('logout error', e);
          showToast("Error logging out. Check console.", "error");
        }
      });
    }

    /* ======= Initial safety UI ======= */
    (function initialState() {
      welcomeText.innerText = 'Welcome, Guest';
      userIdText.innerText = 'User ID: -';
      balanceEl.innerText = '0';
      historyDiv.innerHTML = 'Loading...';
    })();
  </script>
</body>
</html>
