<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — AmeerTech</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<style>
  :root{--bg:#f4f6f8;--card:#fff;--ink:#0f172a;--muted:#64748b;--brand:#0ea5a0;--brand-2:#007f5f;--danger:#ef4444}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); margin:0;padding:24px;color:var(--ink)}
  .wrap{max-width:980px;margin:40px auto}
  .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(2,8,23,.08)}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .col{flex:1;min-width:240px}
  h1{margin:0 0 8px;font-size:20px;font-weight:800}
  .muted{color:var(--muted)}
  .balance{font-size:28px;font-weight:900;margin-top:8px}
  button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
  .btn-primary{background:linear-gradient(135deg,var(--brand-2),var(--brand));color:white}
  .btn-ghost{background:#eef2f2;color:var(--ink)}
  .box{background:#fbfdfe;border-radius:12px;padding:14px}
  .history-list{max-height:280px;overflow:auto;margin-top:10px;border-radius:8px;padding:8px;background:#fff;border:1px solid #eef2f2}
  .hist-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed #f1f5f9}
  .small{font-size:13px;color:var(--muted)}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .toggle{display:flex;gap:8px;align-items:center}
  a.contact{color:var(--brand-2);text-decoration:none;font-weight:700}
  .notice{margin-top:10px;font-size:13px;color:#0f172a}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <div>
        <h1 id="welcome">Welcome</h1>
        <div class="small" id="userId">User ID: —</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="logoutBtn" class="btn-ghost">Logout</button>
      </div>
    </div>

    <div class="row" style="margin-bottom:12px">
      <div class="col box">
        <div class="small">Available balance</div>
        <div class="balance" id="balance">₦0</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="addFundBtn" class="btn-primary">Add Fund</button>
          <button id="refreshBtn" class="btn-ghost">Refresh</button>
        </div>
        <div class="notice">Click <b>Add Fund</b> to top up your wallet with Paystack. After successful payment, balance updates automatically.</div>
      </div>

      <div class="col box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">History</div>
            <div style="font-weight:800">Transactions</div>
          </div>
          <div class="toggle">
            <label class="small" for="showHistoryToggle">Show</label>
            <input id="showHistoryToggle" type="checkbox" checked>
          </div>
        </div>

        <div id="historyWrap" class="history-list"></div>
        <div style="margin-top:8px"><a href="ni.html" class="contact" target="_blank">Get NIN Plastic Now</a></div>
      </div>
    </div>

    <div style="margin-top:12px" class="small">
      Forgot password / support: <a href="https://wa.me/2348145415083" target="_blank">wa.me/08145415083</a>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, onValue, push, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // SAME firebase web config used in your other pages (keeps things consistent)
  const firebaseConfig = {
    apiKey: "AIzaSyDc0bIipHU7N73mju33dNwSWmH3IeIYkog",
    authDomain: "ameernin-ba310.firebaseapp.com",
    databaseURL: "https://ameernin-ba310-default-rtdb.firebaseio.com",
    projectId: "ameernin-ba310",
    storageBucket: "ameernin-ba310.appspot.com",
    messagingSenderId: "522206845073",
    appId: "1:522206845073:web:3c85714bd7eda6c1048730",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // UI refs
  const welcomeEl = document.getElementById('welcome');
  const userIdEl = document.getElementById('userId');
  const balanceEl = document.getElementById('balance');
  const historyWrap = document.getElementById('historyWrap');
  const showHistoryToggle = document.getElementById('showHistoryToggle');
  const addFundBtn = document.getElementById('addFundBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  let uid = null;
  let userEmail = null;

  function formatCurrencyKobo(kobo){
    const ngn = Number(kobo || 0) / 100;
    return '₦' + ngn.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:2});
  }
  function formatSimpleDate(ts){
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function renderHistoryItem(item){
    const div = document.createElement('div');
    div.className = 'hist-row';
    div.innerHTML = `<div>
      <div style="font-weight:700">${item.description || item.type || 'Payment'}</div>
      <div class="small">${item.note || ''}</div>
    </div>
    <div style="text-align:right">
      <div style="font-weight:800">${item.type === 'credit' ? '+' : (item.type === 'demo' ? '' : '-')}${formatCurrencyKobo(item.amount || 0)}</div>
      <div class="small">${item.status || ''} • ${formatSimpleDate(item.timestamp || Date.now())}</div>
    </div>`;
    return div;
  }

  // Auth guard & init
  onAuthStateChanged(auth, (user) => {
    if(!user){ window.location.href = 'index.html'; return; }
    uid = user.uid;
    userEmail = user.email || '';
    welcomeEl.textContent = `Welcome, ${user.displayName || user.email || 'User'}`;
    userIdEl.textContent = `User ID: ${uid}`;

    // listen to balance
    const balRef = ref(db, `users/${uid}/balance`);
    onValue(balRef, (snap)=> {
      const val = snap.val() || 0;
      balanceEl.textContent = formatCurrencyKobo(val);
    });

    // listen to transactions list
    const txRef = ref(db, `users/${uid}/transactions`);
    onValue(txRef, (snap)=>{
      const data = snap.val() || {};
      // create array sorted by timestamp desc
      const arr = Object.keys(data).map(k => ({ id:k, ...data[k] }))
                   .sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
      renderHistory(arr);
    });
  });

  function renderHistory(list){
    historyWrap.innerHTML = '';
    if(!showHistoryToggle.checked){ historyWrap.style.display = 'none'; return; }
    historyWrap.style.display = 'block';
    if(list.length === 0){
      historyWrap.innerHTML = '<div class="small" style="padding:8px">No transactions yet.</div>'; return;
    }
    list.forEach(item => historyWrap.appendChild(renderHistoryItem(item)));
  }

  showHistoryToggle.addEventListener('change', ()=>{
    // toggle visibility — real-time listener will call renderHistory
    if(!showHistoryToggle.checked) historyWrap.style.display = 'none';
    else historyWrap.style.display = 'block';
  });

  refreshBtn.addEventListener('click', async ()=>{
    if(!uid) return;
    // manual quick refresh: read balance and last 10 transactions
    try{
      const dbRef = ref(db);
      const snap = await get(child(dbRef, `users/${uid}`));
      const userObj = snap.val() || {};
      const bal = userObj.balance || 0;
      balanceEl.textContent = formatCurrencyKobo(bal);
      const txs = userObj.transactions ? Object.keys(userObj.transactions).map(k=>({id:k,...userObj.transactions[k]})).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)) : [];
      renderHistory(txs);
    }catch(e){ console.error(e); alert('Refresh failed'); }
  });

  logoutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
    window.location.href = 'index.html';
  });

  // -----------------------
  // Paystack flow: Add Fund
  // -----------------------
  async function loadPaystackScript(){
    if(window.PaystackPop) return;
    return new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = 'https://js.paystack.co/v1/inline.js';
      s.onload = res; s.onerror = rej;
      document.body.appendChild(s);
    });
  }

  addFundBtn.addEventListener('click', async ()=>{
    if(!uid) return alert('User not loaded');
    let amount = prompt('Enter amount to add (NGN):', '500');
    if(!amount) return;
    amount = parseFloat(amount);
    if(isNaN(amount) || amount <= 0) return alert('Invalid amount');

    try{
      // ask Netlify function to create transaction & return reference + publicKey
      const createRes = await fetch('/.netlify/functions/create-transaction', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ userId: uid, amount }) // amount in NGN
      });
      const createData = await createRes.json();
      if(createRes.status !== 200){ console.error(createData); return alert('Could not initiate payment'); }
      const { reference, publicKey } = createData;

      await loadPaystackScript();

      const handler = window.PaystackPop.setup({
        key: publicKey,
        email: userEmail || '', 
        amount: Math.round(amount * 100), // kobo
        ref: reference,
        onClose: function(){ alert('Payment window closed'); },
        callback: async function(response){
          // call verify endpoint
          try{
            const verifyRes = await fetch(`/.netlify/functions/verify-transaction?reference=${encodeURIComponent(response.reference)}`);
            const verifyJson = await verifyRes.json();
            if(verifyRes.status === 200 && verifyJson.status === 'success'){
              alert('Payment verified and balance updated.');
              // balance will update automatically via DB listener
            } else {
              console.warn('verify failed', verifyJson);
              alert('Payment not verified: ' + (verifyJson.message || 'unknown'));
            }
          }catch(err){
            console.error('Verify error', err);
            alert('Verification failed: ' + (err.message || err));
          }
        }
      });
      handler.openIframe();
    }catch(err){
      console.error(err);
      alert('Payment initiation failed: ' + (err.message || err));
    }
  });

  // ensure graceful fallback if offline or not authenticated
</script>
</body>
</html>
